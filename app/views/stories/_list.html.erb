<% filter_params = local_assigns.fetch(:filter_params, {}) %>

<div class="story-cards">
  <% stories.each do |story| %>
    <article class="story-card" data-controller="story-card" data-story-card-url-value="<%= story_path(story) %>" data-action="click->story-card#open keydown->story-card#openWithKey" tabindex="0" role="button" aria-label="<%= story.title %>">
      <div class="story-card__body">
        <h3 class="story-card__title">
          <%= link_to story.title, story_path(story), data: { turbo_frame: "story_detail" } %>
        </h3>
        <div class="story-card__meta">
          <span><%= story.story_type.presence || t("stories.detail.type_unknown") %></span>
          <span><%= story.current_state.presence || t("stories.detail.state_unknown") %></span>
          <% if story.priority.present? %>
            <span><%= story.priority %></span>
          <% end %>
          <% if story.story_created_at.present? %>
            <span><%= l(story.story_created_at.to_date, format: :long) %></span>
          <% end %>
        </div>
        <% if story.story_labels.any? %>
          <ul class="story-card__tags">
            <% story.story_labels.first(6).each do |label| %>
              <li>
                <button type="button" data-action="story-card#applyLabel" data-story-card-label-param="<%= label.name %>"><%= label.name %></button>
              </li>
            <% end %>
            <% if story.story_labels.size > 6 %>
              <li>…</li>
            <% end %>
          </ul>
        <% end %>
      </div>
      <div class="story-card__aside">
        <% if story.epic.present? %>
          <span class="story-card__badge story-card__badge--epic"><%= story.epic.name %></span>
        <% end %>
        <% if story.estimate.present? %>
          <span class="story-card__badge"><%= t("stories.detail.points", points: story.estimate) %></span>
        <% end %>
        <% story.story_ownerships.first(3).each do |ownership| %>
          <button type="button" class="story-card__badge story-card__badge--owner" data-action="story-card#applyOwner" data-story-card-owner-param="<%= ownership.owner_name %>"><%= ownership.owner_name %></button>
        <% end %>
        <% if story.story_ownerships.size > 3 %>
          <span class="story-card__badge story-card__badge--owner story-card__badge--static">…</span>
        <% end %>
      </div>
    </article>
  <% end %>
</div>

<% if stories.empty? %>
  <p class="story-list__empty"><%= t("stories.list.empty") %></p>
<% elsif next_page %>
  <div class="story-list__pagination">
    <div class="story-list__hint"><%= t("stories.pagination.auto_load_hint") %></div>
    <%= link_to t("stories.pagination.load_more"), stories_path(page: next_page, filter: filter_params),
                class: "button button--secondary",
                data: { turbo_frame: "stories_list", "infinite-scroll-target": "link" } %>
    <div class="story-list__loading" data-infinite-scroll-target="sentinel"><%= t("stories.pagination.loading") %></div>
  </div>
<% else %>
  <p class="story-list__end"><%= t("stories.pagination.all_loaded") %></p>
<% end %>
